version: "3"

services:
  mysql:
    image: "mysql:8.0"
    container_name: mysql
    environment:
      MYSQL_ROOT_PASSWORD: ssafy
      MYSQL_DATABASE: love
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    restart: always
    networks:
      - backend

  redis:
    image: "redis:latest"
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: always
    networks:
      - backend

  discoveryservice:
    image: discoveryservice:latest
    container_name: discoveryservice
    build:
      context: ./discoveryservice
      dockerfile: Dockerfile
    ports:
      - "8761:8761"
    restart: always
    networks:
      - backend

  apigateway:
    image: apigateway:latest
    container_name: apigateway
    build:
      context: ./apigateway
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    depends_on:
      - discoveryservice
    restart: always
    networks:
      - backend

  config:
    image: config:latest
    container_name: config
    build:
      context: ./config
      dockerfile: Dockerfile
    ports:
      - "8888:8888"
    depends_on:
      - discoveryservice
    restart: always
    networks:
      - backend

  member-service:
    image: member-service:latest
    container_name: member-service
    build:
      context: ./MemberService
      dockerfile: Dockerfile
    restart: always
    networks:
      - backend

  team-service:
    image: team-service:latest
    container_name: team-service
    build:
      context: ./TeamService
      dockerfile: Dockerfile
    restart: always
    networks:
      - backend

  chatting-service:
    image: chatting-service:latest
    container_name: chatting-service
    build:
      context: ./chatting-service
      dockerfile: Dockerfile
    restart: always
    networks:
      - backend

  file-service:
    image: file-service:latest
    container_name: file-service
    build:
      context: ./file-service
      dockerfile: Dockerfile
    restart: always
    networks:
      - backend

  sonarqube:
    image: sonarqube:latest
    container_name: sonarqube
    environment:
      - SONARQUBE_JDBC_URL=jdbc:postgresql://postgres:5432/sonar
      - SONARQUBE_JDBC_USERNAME=sonar
      - SONARQUBE_JDBC_PASSWORD=sonar
    ports:
      - "9000:9000"
    depends_on:
      - postgres
    restart: always
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs
    networks:
      - sonarnet

  postgres:
    image: postgres:latest
    container_name: postgres
    environment:
      - POSTGRES_USER=sonar
      - POSTGRES_PASSWORD=sonar
      - POSTGRES_DB=sonar
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - sonarnet

volumes:
  mysql-data:
  redis-data:
  sonarqube_data:
  sonarqube_extensions:
  sonarqube_logs:
  postgres_data:

networks:
  backend:
    name: shared_backend
  sonarnet:
    name: shared_sonarnet
